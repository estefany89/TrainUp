<!-- rutinas_socio.html - VERSI√ìN MEJORADA -->
{% extends 'gimnasio/base.html' %}

{% block content %}
<div id="app">
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="bi bi-list-check text-success"></i> Rutinas de Ejercicio
            </h2>
            <div class="badge bg-success fs-6" v-if="!cargando && rutinas.length > 0">
                [[ rutinas.length ]] ejercicios
            </div>
        </div>

        <!-- Mensaje de error -->
        <div v-if="error" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Error:</strong> [[ error ]]
            <button type="button" class="btn-close" @click="error = ''"></button>
        </div>

        <!-- Indicador de carga -->
        <div v-if="cargando" class="text-center mt-5 mb-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando rutinas desde la API...</p>
        </div>

        <!-- Estad√≠sticas (opcional, para debug) -->
        <div v-if="!cargando && rutinas.length > 0" class="alert alert-info alert-dismissible fade show mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Estad√≠sticas:</strong>
            <span class="ms-2">
                Total: [[ rutinas.length ]] |
                Con imagen: [[ conImagen ]] |
                Sin imagen: [[ sinImagen ]]
            </span>
            <button type="button" class="btn-close" @click="mostrarEstadisticas = false" v-if="mostrarEstadisticas"></button>
        </div>

        <!-- Mensaje cuando no hay rutinas -->
        <div v-if="!cargando && rutinas.length === 0 && !error" class="alert alert-warning text-center mt-4">
            <i class="bi bi-info-circle"></i>
            No se encontraron ejercicios disponibles en este momento.
        </div>

        <!-- Grid de rutinas -->
        <div v-if="rutinas.length > 0" class="row mt-3">
            <div class="col-md-6 col-lg-4 mb-4" v-for="(rutina, index) in rutinas" :key="rutina.id">
                <div class="card h-100 shadow-sm hover-card">
                    <!-- Imagen del ejercicio -->
                    <div class="position-relative" style="height: 200px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <img v-if="rutina.image"
                             :src="rutina.image"
                             class="card-img-top exercise-image"
                             :alt="rutina.name"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             @error="handleImageError($event, index)"
                             @load="handleImageLoad(index)">

                        <!-- Placeholder cuando no hay imagen o falla -->
                        <div v-if="!rutina.image || rutina.imageError"
                             class="d-flex flex-column align-items-center justify-content-center h-100 text-white">
                            <i class="bi bi-activity" style="font-size: 4rem; opacity: 0.7;"></i>
                            <p class="mt-2 mb-0 fw-bold text-uppercase" style="font-size: 0.9rem; letter-spacing: 1px;">
                                [[ rutina.category ]]
                            </p>
                        </div>

                        <!-- Badge de categor√≠a sobre la imagen -->
                        <div v-if="rutina.image && !rutina.imageError"
                             class="position-absolute top-0 end-0 m-2">
                            <span class="badge bg-dark bg-opacity-75">
                                [[ rutina.category ]]
                            </span>
                        </div>

                        <!-- Indicador de imagen ilustrativa (opcional) -->
                        <div v-if="rutina.is_fallback_image"
                             class="position-absolute bottom-0 start-0 m-2">
                            <span class="badge bg-info bg-opacity-75" style="font-size: 0.7rem;">
                                <i class="bi bi-image"></i> Ilustrativa
                            </span>
                        </div>
                    </div>

                    <div class="card-body d-flex flex-column">
                        <!-- T√≠tulo -->
                        <h5 class="card-title text-success fw-bold mb-3">
                            <i class="bi bi-trophy-fill"></i>
                            [[ rutina.name ]]
                        </h5>

                        <!-- Descripci√≥n -->
                        <div class="card-text small mb-3 text-muted flex-grow-1"
                             v-html="truncateDescription(rutina.description)">
                        </div>

                        <hr class="my-2">

                        <!-- Informaci√≥n adicional -->
                        <div class="small">
                            <!-- M√∫sculos -->
                            <div v-if="rutina.muscles && rutina.muscles.length > 0 && rutina.muscles[0] !== 'No especificado'"
                                 class="mb-2">
                                <strong class="d-block mb-1">
                                    <i class="bi bi-heart-pulse-fill text-danger"></i> M√∫sculos:
                                </strong>
                                <span v-for="(musculo, idx) in rutina.muscles"
                                      :key="'m-'+idx"
                                      class="badge bg-danger me-1 mb-1">
                                    [[ musculo ]]
                                </span>
                            </div>

                            <!-- Equipamiento -->
                            <div v-if="rutina.equipment && rutina.equipment.length > 0 && rutina.equipment[0] !== 'Sin equipo'">
                                <strong class="d-block mb-1">
                                    <i class="bi bi-tools text-warning"></i> Equipamiento:
                                </strong>
                                <span v-for="(equipo, idx) in rutina.equipment"
                                      :key="'e-'+idx"
                                      class="badge bg-warning text-dark me-1 mb-1">
                                    [[ equipo ]]
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>
console.log(' Iniciando aplicaci√≥n Vue.js...');

var app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
        rutinas: [],
        error: '',
        cargando: true,
        mostrarEstadisticas: true
    },
    computed: {
        conImagen() {
            return this.rutinas.filter(r => r.image && !r.imageError).length;
        },
        sinImagen() {
            return this.rutinas.filter(r => !r.image || r.imageError).length;
        }
    },
    methods: {
        handleImageError(event, index) {
            console.warn('‚ùå Error cargando imagen para:', this.rutinas[index].name);
            // Marcar como error para mostrar placeholder
            this.$set(this.rutinas[index], 'imageError', true);
        },

        handleImageLoad(index) {
            console.log('‚úÖ Imagen cargada correctamente para:', this.rutinas[index].name);
            this.$set(this.rutinas[index], 'imageError', false);
        },

        truncateDescription(desc) {
            if (!desc || desc === 'Sin descripci√≥n disponible') {
                return '<em class="text-muted">Sin descripci√≥n disponible</em>';
            }

            // Eliminar HTML b√°sico y truncar
            const plainText = desc.replace(/<[^>]*>/g, '');
            if (plainText.length > 120) {
                return plainText.substring(0, 120) + '...';
            }
            return plainText;
        }
    },
    mounted() {
        console.log('üì° Vue montado, iniciando carga de datos...');

        fetch('{% url "gimnasio:api_rutinas" %}')
            .then(response => {
                console.log('üì• Respuesta recibida:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Datos parseados correctamente');
                console.log('üìä Estad√≠sticas:', {
                    tipo: typeof data,
                    esArray: Array.isArray(data),
                    cantidad: data.length
                });

                if (data.length > 0) {
                    console.log('üîç Muestra del primer ejercicio:', {
                        nombre: data[0].name,
                        categoria: data[0].category,
                        tieneImagen: !!data[0].image,
                        imagen: data[0].image
                    });
                }

                // Asignar datos a Vue
                this.rutinas = data.map(rutina => ({
                    ...rutina,
                    imageError: false  // Inicializar control de error
                }));

                this.cargando = false;

                console.log(`‚ú® ${this.rutinas.length} rutinas cargadas en Vue`);

                // Contar im√°genes
                const conImagenes = this.rutinas.filter(r => r.image).length;
                console.log(`üñºÔ∏è ${conImagenes} ejercicios con imagen (${((conImagenes/this.rutinas.length)*100).toFixed(1)}%)`);
            })
            .catch(err => {
                console.error('üí• ERROR FATAL:', {
                    mensaje: err.message,
                    stack: err.stack
                });

                this.error = `No se pudieron cargar las rutinas: ${err.message}`;
                this.cargando = false;
            });
    }
});

console.log('‚úÖ Instancia de Vue creada correctamente');
</script>

<style>
/* Animaci√≥n de hover para las cards */
.hover-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
}

.hover-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.2) !important;
}

/* Animaci√≥n suave para las im√°genes */
.exercise-image {
    transition: transform 0.3s ease;
}

.hover-card:hover .exercise-image {
    transform: scale(1.05);
}

/* Mejorar la apariencia del texto truncado */
.card-text {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.5;
}

/* Badges m√°s modernos */
.badge {
    font-weight: 500;
    padding: 0.4em 0.7em;
    font-size: 0.85em;
}

/* Gradiente para placeholder */
.card-img-top {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-title {
        font-size: 1.1rem;
    }

    .card-text {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}